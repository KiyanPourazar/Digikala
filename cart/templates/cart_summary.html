{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<!-- Header -->
<header class="bg-dark py-5">
  <div class="container px-4 px-lg-5 my-5">
    <div class="text-center text-white">
      <h1 class="display-4 fw-bolder">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</h1>
      <p class="lead fw-normal text-white-50 mb-0">Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø±ÛŒØ¯Ù‡Ø§ÛŒ Ø´Ù…Ø§</p>
    </div>
  </div>
</header>

<!-- Cart Section -->
<section class="py-5">
  <div class="container px-4 px-lg-5">

    {% if cart_products %}
      <div class="table-responsive">
        <table class="table table-hover text-center align-middle">
          <thead class="table-dark">
            <tr>
              <th>ØªØµÙˆÛŒØ±</th>
              <th>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</th>
              <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
              <th>ØªØ¹Ø¯Ø§Ø¯</th>
              <th>Ø¬Ù…Ø¹ Ø¬Ø²Ø¡</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody>
            {% for product in cart_products %}
            <tr id="product-row-{{ product.id }}">
              <td style="width:100px;">
                {% if product.picture %}
                  <img src="{{ product.picture.url }}" alt="{{ product.name }}" class="img-fluid rounded" style="max-height:80px;">
                {% else %}
                  <img src="{% static 'img/no-image.png' %}" alt="Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±" class="img-fluid rounded" style="max-height:80px;">
                {% endif %}
              </td>

              <td class="fw-bold">{{ product.name }}</td>
              <td>{{ product.price|intcomma }} ØªÙˆÙ…Ø§Ù†</td>
              <td style="width:100px;">
                <input type="number" min="1" class="form-control text-center quantity-input"
                       data-product="{{ product.id }}"
                       value="{{ product.quantity }}">
              </td>
              <td class="product-total" id="total-{{ product.id }}">{{ product.total|intcomma }} ØªÙˆÙ…Ø§Ù†</td>
              <td>
                <button class="btn btn-sm btn-outline-danger remove-from-cart" data-product="{{ product.id }}">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="text-end mt-4">
        <h4>Ø¬Ù…Ø¹ Ú©Ù„: <strong id="cart-total">{{ total_price|intcomma }} ØªÙˆÙ…Ø§Ù†</strong></h4>
        <a href="{% url 'shop' %}" class="btn btn-outline-secondary mt-3">Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯</a>
        <a href="#" class="btn btn-success mt-3 ms-2">ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨</a>
      </div>

    {% else %}
      <div class="text-center py-5">
        <h4 class="text-muted">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª ğŸ›’</h4>
        <a href="{% url 'shop' %}" class="btn btn-outline-dark mt-3">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</a>
      </div>
    {% endif %}

  </div>
</section>

<!-- AJAX Ø­Ø°Ù Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ -->
<script>
  $(document).ready(function(){

    // ğŸ—‘ Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„ Ø§Ø² Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
    $(document).on('click', '.remove-from-cart', function(e) {
      e.preventDefault();
      const productId = $(this).data('product');

      $.ajax({
        type: 'POST',
        url: "{% url 'cart_remove' %}",
        data: {
          product_id: productId,
          csrfmiddlewaretoken: '{{ csrf_token }}',
          action: 'post'
        },
        success: function(json) {
          // Ø­Ø°Ù Ø³Ø·Ø± Ø§Ø² Ø¬Ø¯ÙˆÙ„
          $("#product-row-" + productId).remove();
          // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ù…Ø¹ Ú©Ù„
          $("#cart-total").text(json.total_price.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†');

          // Ø§Ú¯Ø± Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø´Ø¯:
          if (json.total_price === 0) {
            location.reload();
          }
        },
        error: function(xhr, errmsg, err) {
          console.log('Error:', errmsg);
        }
      });
    });

    // ğŸ”„ ØªØºÛŒÛŒØ± ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­ØµÙˆÙ„
    $(document).on('change', '.quantity-input', function(e) {
      const productId = $(this).data('product');
      const quantity = $(this).val();

      $.ajax({
        type: 'POST',
        url: "{% url 'cart_update' %}",
        data: {
          product_id: productId,
          quantity: quantity,
          csrfmiddlewaretoken: '{{ csrf_token }}',
          action: 'post'
        },
        success: function(json) {
          // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ù…Ø¹ Ø¬Ø²Ø¡ Ùˆ Ú©Ù„
          $("#total-" + productId).text(json.item_total.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†');
          $("#cart-total").text(json.total_price.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†');
        },
        error: function(xhr, errmsg, err) {
          console.log('Error:', errmsg);
        }
      });
    });

  });
</script>

{% endblock %}
