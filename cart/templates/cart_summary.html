{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<!-- Header -->
<header class="bg-dark py-5">
  <div class="container px-4 px-lg-5 my-5">
    <div class="text-center text-white">
      <h1 class="display-4 fw-bolder">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</h1>
      <p class="lead fw-normal text-white-50 mb-0">Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø±ÛŒØ¯Ù‡Ø§ÛŒ Ø´Ù…Ø§</p>
    </div>
  </div>
</header>

<!-- Cart Section -->
<section class="py-5">
  <div class="container px-4 px-lg-5">

    {% if cart_products %}
      <div class="table-responsive">
        <table class="table table-hover text-center align-middle">
          <thead class="table-dark">
            <tr>
              <th>ØªØµÙˆÛŒØ±</th>
              <th>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</th>
              <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
              <th>ØªØ¹Ø¯Ø§Ø¯</th>
              <th>Ø¬Ù…Ø¹ Ø¬Ø²Ø¡</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody>
            {% for product in cart_products %}
            <tr id="product-row-{{ product.id }}">
              <td style="width:100px;">
                {% if product.picture %}
                  <a href="{% url 'product' product.id %}" class="text-decoration-none">
                  <img src="{{ product.picture.url }}" alt="{{ product.name }}" class="img-fluid rounded" style="max-height:80px;">
                  </a>
                {% else %}
                  <img src="{% static 'img/no-image.png' %}" alt="Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±" class="img-fluid rounded" style="max-height:80px;">
                {% endif %}
              </td>

              <td class="fw-bold">
                  <a href="{% url 'product' product.id %}" class="text-dark text-decoration-none">
                    {{ product.name }}
                  </a>
              </td>

              <td>
<!--                {% if product.is_sale %}-->
<!--                  <span class="text-muted text-decoration-line-through">{{ product.original_price|intcomma }} ØªÙˆÙ…Ø§Ù†</span>-->
<!--                  <h5 class="text-danger mt-1">{{ product.sale_price|intcomma }} ØªÙˆÙ…Ø§Ù†</h5>-->
<!--                {% else %}-->
<!--                  <h5 class="text-primary">{{ product.price|intcomma }} ØªÙˆÙ…Ø§Ù†</h5>-->
<!--                {% endif %}-->
              {{ product.price|intcomma }} ØªÙˆÙ…Ø§Ù†

              </td>

              <td style="width:100px;">
                <input type="number" min="1" max="{{ product.stock }}"
                       class="form-control text-center quantity-input"
                       data-product="{{ product.id }}"
                       value="{{ product.quantity }}">
              </td>

              <td class="product-total" id="total-{{ product.id }}">{{ product.total|intcomma }} ØªÙˆÙ…Ø§Ù†</td>

              <td>
                <button class="btn btn-sm btn-outline-danger remove-from-cart" data-product="{{ product.id }}">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="text-end mt-4">
        <h4>Ø¬Ù…Ø¹ Ú©Ù„: <strong id="cart-total">{{ total_price|intcomma }} ØªÙˆÙ…Ø§Ù†</strong></h4>
        <a href="{% url 'shop' %}" class="btn btn-outline-secondary mt-3">Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯</a>
        <a href="#" class="btn btn-success mt-3 ms-2">ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨</a>
      </div>

    {% else %}
      <div class="text-center py-5">
        <h4 class="text-muted">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª ğŸ›’</h4>
        <a href="{% url 'shop' %}" class="btn btn-outline-dark mt-3">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</a>
      </div>
    {% endif %}

  </div>
</section>

<!-- AJAX Ø­Ø°Ù Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ -->
<script>
$(document).ready(function(){

    // ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„ Ø§Ø² Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ùˆ Ø¯Ø±Ø³Øª Ø§Ø³Øª)
    $(document).on('click', '.remove-from-cart', function(e) {
      e.preventDefault();
      const productId = $(this).data('product');

      $.ajax({
        type: 'POST',
        url: "{% url 'cart_remove' %}",
        data: {
          product_id: productId,
          csrfmiddlewaretoken: '{{ csrf_token }}',
          action: 'post'
        },
        success: function(json) {
          // Ø¢Ù¾Ø¯ÛŒØª Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¯Ø± ØµÙØ­Ù‡
          $("#product-row-" + productId).fadeOut(300, function() { $(this).remove(); });
          $("#cart-total").text(json.total_price.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†');
          $('#cart-count').text(json.total_items);

          // Ø§Ú¯Ø± Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø´Ø¯ØŒ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù† ØªØ§ Ù¾ÛŒØ§Ù… "Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª" Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
          if (json.total_items === 0) {
              location.reload();
          }
        },
        error: function(xhr, errmsg, err) {
          console.log('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„:', errmsg);
          alert('Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„ Ø±Ø® Ø¯Ø§Ø¯.');
        }
      });
    });


    // ğŸ”„ ØªØºÛŒÛŒØ± ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­ØµÙˆÙ„ (Ù…Ù†Ø·Ù‚ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ùˆ Ø§Ù…Ù†)

    let previous_quantity; // Ù…ØªØºÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± Ù‚Ø¨Ù„ÛŒ

    // Ù…Ø±Ø­Ù„Ù‡ Û±: ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±ÙˆÛŒ ÙÛŒÙ„Ø¯ Ú©Ù„ÛŒÚ© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ù…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ Ø¢Ù† Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    $(document).on('focus', '.quantity-input', function() {
        previous_quantity = $(this).val();
    });

    // Ù…Ø±Ø­Ù„Ù‡ Û²: ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ø¨Ø± Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯ØŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ù…ÛŒâ€ŒÙØ±Ø³ØªÛŒÙ…
    $(document).on('change', '.quantity-input', function(e) {
      const productId = $(this).data('product');
      const quantity = $(this).val();
      const inputElement = $(this); // Ø®ÙˆØ¯Ù ÙÛŒÙ„Ø¯ input Ø±Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ…

      $.ajax({
        type: 'POST',
        url: "{% url 'cart_update' %}", // Ø§ÛŒÙ† view Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯
        data: {
          product_id: productId,
          quantity: quantity,
          csrfmiddlewaretoken: '{{ csrf_token }}',
          action: 'post'
        },
        success: function(json) {
          // Ø§Ú¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†
          $('#cart-count').text(json.total_items);
          $("#total-" + productId).text(json.item_total.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†');
          $("#cart-total").text(json.total_price.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†');
        },
        error: function(xhr, errmsg, err) {
          // Ù…Ø±Ø­Ù„Ù‡ Û³: Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ø®Ø·Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯ (Ù…Ø«Ù„Ø§ status 400)
          if (xhr.status === 400 && xhr.responseJSON.error) {
              // Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ø² view ÙØ±Ø³ØªØ§Ø¯ÛŒÙ… Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
              alert(xhr.responseJSON.error);
              // Ùˆ Ù…Ù‚Ø¯Ø§Ø± ÙÛŒÙ„Ø¯ Ø±Ø§ Ø¨Ù‡ Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
              inputElement.val(previous_quantity);
          } else {
              console.log('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:', errmsg);
              alert('Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø±Ø® Ø¯Ø§Ø¯.');
              // Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø±ÙˆØ² Ø®Ø·Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ù‡Ù… Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ…
              inputElement.val(previous_quantity);
          }
        }
      });
    });

});
</script>

{% endblock %}
